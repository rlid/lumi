{% extends "index.html" %}
{% from "macros_models.html" import render_message with context %}

{% block mid_col %}
    {{ render_post_card(post, truncate_body=False) }}
    {% for node, last_timestamp in nodes %}
        {% set messages = node.messages_ordered(order_desc=True) %}
        <div class="card mb-3
        {% if messages[0].engagement is not none and messages[0].engagement.state != Engagement.STATE_COMPLETED %}
            border-success
        {% elif messages[0].type == Message.TYPE_REQUEST %}
            border-primary
        {% endif %}
        ">
            <div class="card-header border-0 small
                    {% if messages[0].engagement is not none and messages[0].engagement.state != Engagement.STATE_COMPLETED %}
                 success
                    {% elif messages[0].type == Message.TYPE_REQUEST %}
                 primary
                    {% endif %}
            ">
                <a href="{{ url_for('main.view_node', node_id=node.id) }}"
                   class="text-decoration-none
                    {% if messages[0].engagement is not none and messages[0].engagement.state != Engagement.STATE_COMPLETED %}
                        {% if messages[0].engagement.state == Engagement.STATE_ENGAGED %}
                            text-success"><b>Active engagement with {{ node.creator }}</b>
                   {% endif %}
                   {% else %}
                       {% if messages[0].type == Message.TYPE_REQUEST %}
                           text-primary"><b>Engagement requested by {{ node.creator }}</b>
                       {% else %}
                           text-muted"><b>Recent interactions with {{ node.creator }}</b>
                       {% endif %}
                   {% endif %}
                </a>
            </div>
            <a href="{{ url_for('main.view_node', node_id=node.id) }}" class="text-decoration-none">
                <div class="card-body pt-0">
                    <div class="card-text truncated-lg">
                        {% set current = namespace(timestamp=none) %}
                        {% for message in messages[:5] %}
                            {{ render_message(message, current_user, current.timestamp) }}
                            {% set current.timestamp = message.timestamp %}
                        {% endfor %}
                    </div>
                </div>
            </a>
        </div>
    {% endfor %}
{% endblock %}

{% block right_col %}
    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title text-muted">Think you can help or know someone who can?</h5>
            {% if not current_user.is_authenticated %}
                 <p class="small"><a href="#"> Log in</a> to contribute and earn rewards.</p>
            {% endif %}
            <ul class="small">
                <li><b>Send</b> the poster a message if you need something clarified</li>
                <li><b>Request Engagement</b> when you are ready to help, and earn a reward if the engagement has been rated as successful(+) by both of you</li>
                <li><b>Share</b> it with a friend or on social media / online communities with your circle of friends. Your will earn a reward if  the question is successfully answered through you. <strong>Make sure to use the Share button to generate your unique referer link!</strong></li>
            </ul>
        </div>
    </div>
    {{ super() }}
{% endblock %}