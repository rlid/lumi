{% from "form.html" import render_form %}
{% from "macro_models.html" import render_message with context %}

{% extends "index.html" %}

{% macro engagement_style(engagement) %}
    {% if engagement.state == Engagement.STATE_COMPLETED %}
        {% if engagement.rating_by_asker == 1 and engagement.rating_by_answerer == 1 %}
            {#border-success#}
            {#style="background-color: rgba(25, 135, 84, 0.05)"#}
        {% elif engagement.rating_by_asker == -1 and engagement.rating_by_answerer == 1 %}
            {#border-danger#}
            {#style="background-color: rgba(220, 53, 69, 0.05)"#}
        {% else %}
            {#border-secondary#}
            {#style="background-color: rgba(108, 117, 125, 0.05)"#}
        {% endif %}
    {% else %}
        {#border-primary#}
        {#style="background-color: rgba(13, 110, 253, 0.05)"#}
    {% endif %}
{% endmacro %}

{% macro engagement_class(engagement) %}
    {% if engagement.state == Engagement.STATE_COMPLETED %}
        {% if engagement.rating_by_asker == 1 and engagement.rating_by_answerer == 1 %}
            border-start border-2 border-success
        {% elif engagement.rating_by_asker == -1 and engagement.rating_by_answerer == 1 %}
            border-start border-2 border-danger
        {% else %}
            border-start border-2 border-secondary
        {% endif %}
    {% else %}
        border-start border-2 border-light
    {% endif %}
{% endmacro %}

{% macro button_class(user, node) %}
    {%- if (user == node.post.creator and node.post.type == "buy") or
            (user == node.creator and node.post.type == "sell") -%}
        info
    {%- elif (user == node.post.creator and node.post.type == "sell") or
            (user == node.creator and node.post.type == "buy") -%}
        warning
    {%- else -%}
        danger
    {%- endif -%}
{% endmacro %}

{% macro text_area_style(user, node) %}
    {%- if (user == node.post.creator and node.post.type == "buy") or
            (user == node.creator and node.post.type == "sell") -%}
        background-color: rgba(13, 202, 240, 0.05);border-color: #0dcaf0;height: 10rem
    {%- elif (user == node.post.creator and node.post.type == "sell") or
            (user == node.creator and node.post.type == "buy") -%}
        background-color: rgba(255, 193, 7, 0.05);border-color: #ffc107;height: 10rem
    {%- else -%}
        background-color: red
    {%- endif -%}
{% endmacro %}

{% block main_container %}
    <div class="row justify-content-center">
        <div class="col-12 col-lg-8 col-xl-6">
            {{ render_post_card(node.post, truncate_body=False) }}

            {% set current = namespace(engagement_id=-1, timestamp=none) %}

            {% for message in messages_asc %}
                {% if message.engagement_id != current.engagement_id %}
                    {# message is the initial one or it does not belong to the previous div, start a new div block #}
                    {% if current.engagement_id != -1 %}
                        {# not the initial message, so there must be a previous div tag to close #}
                        </div>
                    {% endif %}
                    {# now start a new div tag depending on the message #}
                    {% if message.engagement is none %}
                        {# message is not associated with any engagement, put in a plain div block #}
                        <div class="px-3 mb-3">
                    {% elif message.engagement == engagement %}
                        {# message belongs to the currently active engagement #}
                        <div class="card border-success">
                        <div class="card-header success text-success border-0 small">
                            <b>Active Engagement</b>
                        </div>
                        <div class="card-body pt-0 pb-3">
                    {% else %}
                        {# message belongs to an engagement that is not currently active #}
                        <div class="px-3 py-1 mb-3 {{ engagement_class(message.engagement) }}"
                                {{ engagement_style(message.engagement) }}>
                    {% endif %}
                    {% set current.engagement_id = message.engagement_id %}
                {% endif %}
                {{ render_message(message, current_user, current.timestamp) }}
                {% set current.timestamp = message.timestamp %}
            {% endfor %}

            {% if current.engagement_id == -1 %}
                {# no message, so need to create a div block #}
                <div class="rounded px-3 mb-3">
            {% endif %}

            <form method="POST">
                {{ form.hidden_tag() }}
                <div class="mb-3">
                    {{ form.text(class_="form-control", placeholder="Message", style=text_area_style(current_user, node)) }}
                </div>
                <div class="d-flex justify-content-between">
                    {{ form.submit(class_="btn btn-" + button_class(current_user, node)) }}

                    {% if current_user == node.creator and (engagement is none or engagement.state != Engagement.STATE_ENGAGED) %}
                        <a class="btn btn-{{- button_class(current_user, node) -}}" href="#">Request Engagement</a>
                    {% endif %}
                    {% if engagement is not none %}
                        {% if engagement.state == Engagement.STATE_REQUESTED %}
                            {% if current_user == node.post.creator %}
                                <a class="btn btn-{{- button_class(current_user, node) -}}" href="#">Accept Engagement</a>
                            {% endif %}
                        {% elif engagement.state == Engagement.STATE_ENGAGED %}
                            {% if (current_user == engagement.asker and engagement.rating_by_asker == 0) or
                                  (current_user == engagement.answerer and engagement.rating_by_answerer == 0) %}
                                <a class="btn btn-{{- button_class(current_user, node) -}}" href="#">Rate Engagement</a>
                            {% endif %}
                        {% endif %}
                    {% endif %}
                </div>
            </form>

            {% if engagement.state == Engagement.STATE_ENGAGED %}
                {# close the div tag for card-body #}
                </div>
            {% endif %}
            </div>
        </div>
    </div>
{% endblock %}
