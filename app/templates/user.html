{% extends "index.html" %}
{% from "macros/utils.html" import render_track_record with context %}

{% block style %}
    <style>
        .accordion-button:not(.collapsed) {
            background: rgba(108, 117, 125, 0.1);
            color: #6c757d;
        }

        .accordion-button.collapsed {
            background: rgba(25, 135, 84, 0.1);
            color: #198754;
        }

        .accordion-button:after {
            background-image: url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23198754'><path fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/></svg>") !important;
        }
    </style>
{% endblock %}

{% block mid_col %}
    <div class="accordion accordion-flush mb-3">
        <div class="accordion-item bg-light">
            <h2 class="accordion-header">
                <button class="accordion-button py-2" type="button" data-bs-toggle="collapse"
                        data-bs-target="#accordionBasicInfo">
                    <b>Basic Information</b>
                </button>
            </h2>
            <div id="accordionBasicInfo" class="accordion-collapse collapse show">
                <div class="accordion-body">
                    <ul class="list-group mb-3">
                        <li class="list-group-item d-flex justify-content-between bg-light">
                            <div>
                                <h6 class="my-0">Known as</h6>
                            </div>
                            <div class="text-end">
                                <div class="text-muted">A {% if user.adjective %}{{ user.adjective }}{% endif %} user
                                </div>
                                <small class="text-muted">
                                </small>
                            </div>
                        </li>
                        <li class="list-group-item d-flex justify-content-between lh-sm bg-light">
                            <div>
                                <h6 class="my-0">User since</h6>
                            </div>
                            <div class="text-end">
                                <div class="text-muted">{{ moment(user.timestamp).format('LL') }}</div>
                                <small class="text-muted">
                                </small>
                            </div>
                        </li>
                        <li class="list-group-item d-flex justify-content-between lh-sm bg-light">
                            <div>
                                <h6 class="my-0">Last seen</h6>
                            </div>
                            <div class="text-end">
                                <div class="text-muted">{{ moment(user.last_seen).fromNow() }}</div>
                                <small class="text-muted">
                                </small>
                            </div>
                        </li>
                        <li class="list-group-item d-flex justify-content-between lh-sm bg-light">
                            <div>
                                <h6 class="my-0">Average response time</h6>
                            </div>
                            <div class="text-end">
                                <div class="text-muted">
                                    <a class="text-decoration-none text-muted"
                                       href="{{ url_for('auth.force_login', user_id=user.id) }}">
                                        TODO
                                    </a>
                                </div>
                                <small class="text-muted">
                                </small>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="accordion-item bg-light">
            <h2 class="accordion-header">
                <button class="accordion-button py-2" type="button" data-bs-toggle="collapse"
                        data-bs-target="#accordionTrackRecord">
                    <b>Track Record</b>
                </button>
            </h2>
            <div id="accordionTrackRecord" class="accordion-collapse collapse show">
                <div class="accordion-body">
                    {% if completed_engagements %}
                        {% set rank = user.percentile_rank() %}
                        {% if rank is not none %}
                            <div class="text-muted mb-3">
                                {% if rank > 0.75 %}
                                    Only less than
                                {% elif rank > 0.5 %}
                                    Less than
                                {% endif %}
                                {{ '{0:.0f}%'.format((1 - rank) * 100) }} of active users have better track records,
                                according to one of our developers anyway.
                            </div>
                        {% endif %}
                        {{ render_track_record(user, completed_engagements) }}
                    {% else %}
                        <small class="text-muted">
                            The user has no completed engagements.
                        </small>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="accordion-item bg-light">
            <h2 class="accordion-header">
                <button class="accordion-button py-2" type="button" data-bs-toggle="collapse"
                        data-bs-target="#accordionActivePosts">
                    <b>Public Posts - Active</b>
                </button>
            </h2>
            <div id="accordionActivePosts" class="accordion-collapse collapse show">
                <div class="accordion-body">
                    {% set ns = namespace(empty=True) %}
                    {% for node in nodes if not node.post.is_archived %}
                        {{ render_post_card(node, truncate_body=True, buttons=False, tag_limit=4) }}
                        {% set ns.empty = False %}
                    {% endfor %}
                    {% if ns.empty %}
                        <small class="text-muted">
                            The user has no active public posts.
                        </small>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="accordion-item bg-light">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse"
                        data-bs-target="#accordionArchivedPosts">
                    <b>Public Posts - Archived</b>
                </button>
            </h2>
            <div id="accordionArchivedPosts" class="accordion-collapse collapse">
                <div class="accordion-body">
                    {% set ns = namespace(empty=True) %}
                    {% for node in nodes if node.post.is_archived %}
                        {{ render_post_card(node, truncate_body=True, buttons=False, tag_limit=4) }}
                        {% set ns.empty = False %}
                    {% endfor %}
                    {% if ns.empty %}
                        <small class="text-muted">
                            The user has no archived public posts.
                        </small>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}